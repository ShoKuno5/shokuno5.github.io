---
import PostLayout from '../layouts/PostLayout.astro';

interface PostData {
  title: string;
  description?: string;
  summary?: string;
  pubDate: Date;
  modified?: Date;
  tags?: string[];
}

interface PostEntry {
  slug: string;
  data: PostData;
  body: string;
  Content: any;
}

interface TagRecord {
  key: string;
  label: string;
  count: number;
}

const { posts = [], topTags = [] }: { posts: PostEntry[]; topTags: TagRecord[] } = Astro.props;
const normalizeTag = (value: string) => value.toLowerCase().replace(/[^a-z0-9]+/g, '-');
---
<div class="meta-links">
  <a class="meta-link" href="/posts/all/">All posts</a>
  <a class="meta-link" href="/posts/tags/">Tags</a>
</div>

{topTags.length > 0 && (
  <div class="meta-chips" role="list">
    {topTags.map(({ key, label, count }) => (
      <button type="button" class="meta-chip" data-tag={key} role="listitem">
        #{label} <span>{count}</span>
      </button>
    ))}
  </div>
)}

<section class="post-inclusions" id="post-feed">
  {posts.map(({ slug, data, body, Content }) => {
    const dataTags = (data.tags ?? []).map(normalizeTag).join(' ');
    return (
      <div class="post-inclusion" data-tags={dataTags}>
        <PostLayout
          title={data.title}
          description={data.description || data.summary}
          date={data.pubDate}
          modified={data.modified}
          tags={data.tags}
          content={body}
          mode="homepage"
          slug={slug}
          showComments={false}
          variant="nested"
        >
          <Content />
        </PostLayout>
      </div>
    );
  })}
</section>

<script is:inline>
  (() => {
    const chips = Array.from(document.querySelectorAll('.meta-chip'));
    const inclusions = Array.from(document.querySelectorAll('.post-inclusion'));
    if (!chips.length || !inclusions.length) return;

    let activeTag = null;

    const setActiveTag = (tag) => {
      activeTag = tag;
      inclusions.forEach((block) => {
        if (!activeTag) {
          block.style.display = '';
          return;
        }
        const tags = (block.dataset.tags || '').split(' ').filter(Boolean);
        block.style.display = tags.includes(activeTag) ? '' : 'none';
      });

      chips.forEach((chip) => {
        chip.classList.toggle('meta-chip--active', chip.dataset.tag === activeTag);
      });
    };

    chips.forEach((chip) => {
      chip.addEventListener('click', () => {
        const tag = chip.dataset.tag;
        setActiveTag(activeTag === tag ? null : tag);
      });
    });
  })();
</script>

<style>
  .meta-links {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 2.5rem;
  }

  .meta-link {
    font-weight: 500;
    font-size: 0.95rem;
    color: #111827;
    text-decoration: none;
    border-bottom: 1px solid transparent;
    padding-bottom: 0.1rem;
    transition: border-color 0.2s ease;
  }

  .meta-link:hover,
  .meta-link:focus-visible {
    border-bottom-color: currentColor;
    outline: none;
  }

  .meta-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-top: 2rem;
  }

  .meta-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.45rem 1rem;
    border-radius: 999px;
    border: 1px solid #d1d5db;
    background: transparent;
    color: #4b5563;
    font-weight: 500;
    font-size: 0.82rem;
    cursor: pointer;
    transition: border-color 0.2s ease, color 0.2s ease;
  }

  .meta-chip span {
    font-size: 0.75rem;
    opacity: 0.75;
  }

  .meta-chip:hover,
  .meta-chip:focus-visible {
    border-color: #111827;
    color: #111827;
    outline: none;
  }

  .meta-chip--active {
    background: #111827;
    border-color: #111827;
    color: #ffffff;
  }

  .post-inclusions {
    display: flex;
    flex-direction: column;
    gap: 3rem;
    margin-top: 3rem;
  }

  .post-inclusion + .post-inclusion {
    border-top: 1px solid #e5e7eb;
    padding-top: 3rem;
  }

  @media (max-width: 640px) {
    .meta-chips {
      gap: 0.5rem;
    }
  }
</style>
