<script>
  // @ts-nocheck
  const initTimelineReveal = () => {
    const items = Array.from(document.querySelectorAll('.post-item[data-reveal]'));
    if (items.length === 0) return;

    const root = document.documentElement;
    let remaining = items.length;
    let safetyTimer = null;

    const revealItem = (item) => {
      if (item.classList.contains('is-visible')) return;
      item.classList.add('is-visible');
      remaining -= 1;
      if (remaining <= 0 && safetyTimer) {
        window.clearTimeout(safetyTimer);
        safetyTimer = null;
      }
    };

    const revealAll = () => {
      items.forEach((item) => revealItem(item));
      root.classList.remove('js-reveal');
    };

    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (prefersReducedMotion || !('IntersectionObserver' in window)) {
      revealAll();
      return;
    }

    root.classList.add('js-reveal');

    // Fail-open: prevent Safari observer edge cases from permanently hiding cards.
    safetyTimer = window.setTimeout(revealAll, 2200);

    try {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (!entry.isIntersecting) return;
            revealItem(entry.target);
            observer.unobserve(entry.target);
          });
        },
        {
          // Threshold 0 avoids missing very tall cards on small iPhone viewports.
          threshold: 0,
          rootMargin: '0px 0px -12% 0px',
        }
      );

      items.forEach((item, index) => {
        item.style.setProperty('--reveal-delay', `${Math.min(index, 8) * 35}ms`);
        observer.observe(item);
      });
    } catch {
      revealAll();
    }
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTimelineReveal, { once: true });
  } else {
    initTimelineReveal();
  }
</script>
