---
import Layout from './Layout.astro';
import CommentsScript from '../components/scripts/CommentsScript.astro';
import PostCard from '../components/PostCard.astro';
import { calculateReadingTime } from '../utils/readingTime';
import { slugToAnchorId } from '../utils/anchors';
import { normalizeTag } from '../utils/tags';
import { hasCitationContent, hasMathContent } from '../utils/contentFeatures';
import { toIssueDisplayTitle, toIssueEditionLabel } from '../utils/issues';

type RelatedPost = { slug: string; title: string; score: number; reasons: string[] };
type CitedByPost = { slug: string; title: string; sharedKeys: string[] };
type IssueContext = { slug: string; title: string; pubDate?: Date };

export interface Props {
  title: string;
  postSlug?: string;
  date?: Date;
  modified?: Date;
  tags?: string[];
  difficulty?: 'intro' | 'intermediate' | 'advanced' | null;
  status?: 'reviewed' | 'evergreen' | 'archived' | null;
  issues?: IssueContext[];
  relatedPosts?: RelatedPost[];
  citedByPosts?: CitedByPost[];
  description?: string;
  content?: string;
}

const {
  title,
  postSlug,
  date,
  modified,
  tags,
  difficulty,
  status,
  issues = [],
  relatedPosts = [],
  citedByPosts = [],
  description,
  content,
} = Astro.props as Props;

const readingTime = content ? calculateReadingTime(content) : null;
const enableMath = content ? hasMathContent(content) : false;
const enableCitations = content ? hasCitationContent(content) : false;

const statusLabel =
  status === 'reviewed'
    ? 'Reviewed'
    : status === 'evergreen'
      ? 'Evergreen'
      : status === 'archived'
        ? 'Archived'
        : null;

const difficultyLabel =
  difficulty === 'intro'
    ? 'Intro'
    : difficulty === 'intermediate'
      ? 'Intermediate'
      : difficulty === 'advanced'
        ? 'Advanced'
        : null;

const lengthLabel =
  readingTime && readingTime.wordCount ? `${readingTime.wordCount.toLocaleString('en-US')} words` : null;
const readingTimeLabel = readingTime ? `${readingTime.readingTime} min read` : null;

const abstract = description?.trim() || '';
const normalizedTags = tags
  ? Array.from(new Set(tags.map((tag) => tag.trim()).filter(Boolean)))
  : [];

const issueContext = postSlug
  ? issues.map((issue) => ({
      label: `${toIssueEditionLabel(issue.title, issue.slug)}: ${toIssueDisplayTitle(issue.title)}`,
      href: `/issues/${issue.slug}/#${slugToAnchorId(postSlug)}`,
    }))
  : [];

const metaPills = [
  ...issueContext,
  ...(readingTimeLabel ? [{ label: readingTimeLabel }] : []),
  ...(lengthLabel ? [{ label: lengthLabel }] : []),
  ...(difficultyLabel ? [{ label: difficultyLabel }] : []),
  ...(statusLabel ? [{ label: statusLabel }] : []),
];

const tagLinks = normalizedTags.map((tag) => ({
  label: tag,
  href: `/tags/#tag-${normalizeTag(tag)}`,
}));
---

<Layout
  title={title}
  description={abstract}
  enableMath={enableMath}
  enableCitations={enableCitations}
>
  <PostCard
    title={title}
    titleTag="h1"
    description={abstract}
    publishedDate={date}
    updatedDate={modified}
    pills={metaPills}
    tagLinks={tagLinks}
    bodyClassName={enableCitations ? 'citations-enabled' : ''}
    className="post-item--full"
    dataPost
  >
    <slot />

    <Fragment slot="after">
      <div class="post-item__after">
        {(citedByPosts.length > 0 || relatedPosts.length > 0) && (
          <section class="post-discovery" aria-label="Discovery">
            {citedByPosts.length > 0 && (
              <div class="post-discovery__block">
                <h2>Cited By Other Posts</h2>
                <ul>
                  {citedByPosts.map((post) => (
                    <li>
                      <a
                        href={`/posts/${post.slug}/`}
                        data-track-event="citation_graph_click"
                        data-track-meta={`target:${post.slug}`}
                      >
                        {post.title}
                      </a>
                      <span>
                        {' '}
                        ({post.sharedKeys.length} shared reference{post.sharedKeys.length === 1 ? '' : 's'})
                      </span>
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {relatedPosts.length > 0 && (
              <div class="post-discovery__block">
                <h2>Related Posts</h2>
                <ul>
                  {relatedPosts.map((post) => (
                    <li>
                      <a
                        href={`/posts/${post.slug}/`}
                        data-track-event="related_post_click"
                        data-track-meta={`target:${post.slug}`}
                      >
                        {post.title}
                      </a>
                      {post.reasons.length > 0 && (
                        <p class="post-discovery__reasons">{post.reasons.join(' | ')}</p>
                      )}
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </section>
        )}

        <div
          class="post-comments"
          data-comments-root
          data-repo="ShoKuno5/shokuno5.github.io"
          data-repo-id="R_kgDOO_0Lcg"
          data-category="Announcements"
          data-category-id="DIC_kwDOO_0Lcs4Cr6Ty"
          data-mapping="pathname"
          data-strict="0"
          data-reactions-enabled="1"
          data-emit-metadata="0"
          data-input-position="bottom"
          data-theme="preferred_color_scheme"
          data-lang="en"
        >
          <button class="comments-trigger" type="button" data-load-comments>
            Load discussion
          </button>
          <div data-comments-mount></div>
          <noscript>
            Enable JavaScript to load comments.
          </noscript>
        </div>
      </div>
    </Fragment>
  </PostCard>

  <CommentsScript slot="scripts" />
</Layout>
