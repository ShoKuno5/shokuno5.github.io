---
import Layout from './Layout.astro';
import CommentsScript from '../components/scripts/CommentsScript.astro';
import { calculateReadingTime } from '../utils/readingTime';
import { normalizeTag } from '../utils/tags';
import { hasCitationContent, hasMathContent } from '../utils/contentFeatures';

export interface Props {
  title: string;
  date?: Date;
  modified?: Date;
  tags?: string[];
  description?: string;
  content?: string;
}

const { title, date, modified, tags, description, content } = Astro.props as Props;

const readingTime = content ? calculateReadingTime(content) : null;
const enableMath = content ? hasMathContent(content) : false;
const enableCitations = content ? hasCitationContent(content) : false;

const publishLabel = date
  ? `Published ${date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`
  : null;

const updatedLabel =
  date && modified && modified.getTime() !== date.getTime()
    ? `Last updated ${modified.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
      })}`
    : null;

const readingLabel = readingTime
  ? `${readingTime.readingTimeText}${readingTime.wordCount ? ` - ${readingTime.wordCount} words` : ''}`
  : null;

const metaItems = [publishLabel, updatedLabel, readingLabel].filter(Boolean);
---

<Layout
  title={title}
  description={description}
  enableMath={enableMath}
  enableCitations={enableCitations}
>
  <article class="post-shell">
    <header class="post-header">
      <h1 class="post-title">{title}</h1>
      {description && <p class="post-summary">{description}</p>}

      {metaItems.length > 0 && (
        <ul class="post-meta">
          {metaItems.map((item) => (
            <li>{item}</li>
          ))}
        </ul>
      )}

      {tags && tags.length > 0 && (
        <ul class="post-tags">
          {tags.map((tag) => (
            <li>
              <a class="post-tag" href={`/tags/#tag-${normalizeTag(tag)}`}>
                #{tag}
              </a>
            </li>
          ))}
        </ul>
      )}
    </header>

    <div class={`post-body markdown-body${enableCitations ? ' citations-enabled' : ''}`}>
      <slot />
    </div>

    <div
      class="post-comments"
      data-comments-root
      data-repo="ShoKuno5/shokuno5.github.io"
      data-repo-id="R_kgDOO_0Lcg"
      data-category="Announcements"
      data-category-id="DIC_kwDOO_0Lcs4Cr6Ty"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="bottom"
      data-theme="preferred_color_scheme"
      data-lang="en"
    >
      <button class="comments-trigger" type="button" data-load-comments>
        Load discussion
      </button>
      <div data-comments-mount></div>
      <noscript>
        Enable JavaScript to load comments.
      </noscript>
    </div>
  </article>

  <CommentsScript slot="scripts" />
</Layout>
