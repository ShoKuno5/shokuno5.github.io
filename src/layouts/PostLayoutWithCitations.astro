---
import Layout from './Layout.astro';
import { calculateReadingTime } from '../utils/readingTime';

export interface Props {
  title: string;
  date?: Date;
  modified?: Date;
  tags?: string[];
  description?: string;
  showMeta?: boolean;
  showComments?: boolean;
  content?: string;
  mode?: 'homepage' | 'full';
  slug?: string;
  variant?: 'default' | 'meta' | 'nested';
}

const props = Astro.props as Props;
const {
  title,
  date,
  modified,
  tags,
  description,
  showMeta = true,
  showComments = true,
  content,
  mode = 'full',
  slug,
  variant = 'default',
} = props;

const isHomepageMode = mode === 'homepage';
const actualShowComments = isHomepageMode ? false : showComments;
const readingTime = content ? calculateReadingTime(content) : null;
const tagToAnchor = (value: string) => value.toLowerCase().replace(/[^a-z0-9]+/g, '-');

const publishLabel = date
  ? `Published ${date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`
  : null;
const updatedLabel = date && modified && modified.getTime() !== date.getTime()
  ? `Updated ${modified.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`
  : null;
const readingLabel = readingTime
  ? `${readingTime.readingTimeText}${readingTime.wordCount ? ` · ${readingTime.wordCount} words` : ''}`
  : null;

const metaItems = [publishLabel, updatedLabel, readingLabel].filter(Boolean);
const articleClasses = [
  'page-width',
  'post-shell',
  isHomepageMode ? 'post-shell--excerpt' : 'post-shell--full',
];

if (variant === 'meta') articleClasses.push('post-shell--meta');
if (variant === 'nested') articleClasses.push('post-shell--nested');

const articleClass = articleClasses.filter(Boolean).join(' ');
---
{(() => {
  const articleBody = (
    <>
      <header class="post-header">
        <h1 class="post-title">
          {isHomepageMode && slug ? (
            <a href={`/posts/${slug}/`} class="post-title__link">{title}</a>
          ) : (
            title
          )}
        </h1>

        {showMeta && metaItems.length > 0 && (
          <ul class="post-meta">
            {metaItems.map((item) => (
              <li>{item}</li>
            ))}
          </ul>
        )}

        {tags && tags.length > 0 && (
          <ul class="post-tags">
            {tags.map((tag) => (
              <li>
                <a class="post-tag" href={`/posts/tags/#tag-${tagToAnchor(tag)}`}>#{tag}</a>
              </li>
            ))}
          </ul>
        )}
      </header>

      <div class="post-body markdown-body citations-enabled">
        <slot />
      </div>

      {actualShowComments && (
        <div class="post-comments">
          <script
            src="https://giscus.app/client.js"
            data-repo="ShoKuno5/shokuno5.github.io"
            data-repo-id="R_kgDOO_0Lcg"
            data-category="Announcements"
            data-category-id="DIC_kwDOO_0Lcs4Cr6Ty"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="bottom"
            data-theme="preferred_color_scheme"
            data-lang="en"
            data-loading="lazy"
            crossorigin="anonymous"
            async
            is:inline>
          </script>
        </div>
      )}

      {isHomepageMode && slug && (
        <footer class="post-footer">
          <a class="post-footer__link" href={`/posts/${slug}/`}>
            Open post ↗
          </a>
        </footer>
      )}
    </>
  );

  const articleNode = <article class={articleClass}>{articleBody}</article>;

  return isHomepageMode ? articleNode : (
    <Layout title={title} description={description}>
      {articleNode}
    </Layout>
  );
})()}

<style>
  .post-shell {
    display: flex;
    flex-direction: column;
    gap: 2.5rem;
    color: #111827;
  }

  .post-shell--excerpt {
    gap: 2rem;
  }

  .post-shell--meta {
    gap: 2.75rem;
  }

  .post-shell--nested {
    gap: 1.75rem;
  }


  .post-header {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .post-title {
    margin: 0;
    font-size: clamp(2rem, 4vw, 2.6rem);
    font-weight: 600;
    letter-spacing: -0.015em;
  }

  .post-shell--nested .post-title {
    font-size: clamp(1.6rem, 3vw, 2rem);
  }

  .post-title__link {
    color: inherit;
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s ease;
  }

  .post-title__link:hover {
    border-bottom-color: currentColor;
  }

  .post-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin: 0;
    padding: 0;
    list-style: none;
    font-size: 0.95rem;
    color: #4b5563;
  }

  .post-meta li {
    display: inline-flex;
    align-items: center;
  }

  .post-meta li + li::before {
    content: '·';
    margin: 0 0.6rem;
    color: #9ca3af;
  }

  .post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.6rem;
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .post-tag {
    text-decoration: none;
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: #6b7280;
    transition: color 0.2s ease;
  }

  .post-tag:hover {
    color: #111827;
  }

  .post-body {
    display: flex;
    flex-direction: column;
    gap: 1.75rem;
  }

  .post-comments {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid #e5e7eb;
  }

  .post-footer {
    margin-top: -0.5rem;
  }

  .post-footer__link {
    font-size: 0.9rem;
    color: #111827;
    text-decoration: none;
    border-bottom: 1px solid currentColor;
    padding-bottom: 0.1rem;
  }

  .post-footer__link:hover {
    color: #0b0b0b;
  }

  .post-shell--excerpt .post-comments {
    display: none;
  }

  .post-shell--nested .post-footer {
    display: none;
  }

  .citations-enabled {
    counter-reset: citation;
  }

  .citations-enabled sup[data-citation]::before {
    counter-increment: citation;
    content: '[' counter(citation) ']';
    font-size: 0.75rem;
    margin-left: 0.2rem;
  }

  .citations-enabled .references {
    border-top: 1px solid #e5e7eb;
    padding-top: 2rem;
    margin-top: 3rem;
    font-size: 0.95rem;
    color: #4b5563;
  }

  .citations-enabled .references h2 {
    font-size: 1.2rem;
    margin-bottom: 1rem;
    color: #111827;
  }

  .citations-enabled .references ol {
    padding-left: 1.25rem;
    margin: 1.5rem 0 0;
    line-height: 1.6;
  }

  .citations-enabled .references li {
    margin: 0.75rem 0;
  }

  .sophisticated-markdown {
    font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-size: 1.05rem;
    line-height: 1.75;
    color: #1f2937;
  }

  .sophisticated-markdown h1,
  .sophisticated-markdown h2,
  .sophisticated-markdown h3,
  .sophisticated-markdown h4,
  .sophisticated-markdown h5,
  .sophisticated-markdown h6 {
    font-weight: 600;
    line-height: 1.25;
    margin: 2.5rem 0 1rem;
    color: #111827;
  }

  .sophisticated-markdown h2 { font-size: 1.8rem; }
  .sophisticated-markdown h3 { font-size: 1.4rem; }

  .sophisticated-markdown p {
    margin: 1.5rem 0;
  }

  .sophisticated-markdown p:first-of-type {
    font-size: 1.15rem;
    line-height: 1.8;
  }

  .sophisticated-markdown a {
    color: #111827;
    text-decoration: none;
    border-bottom: 1px solid rgba(17, 24, 39, 0.25);
    transition: border-color 0.2s ease;
  }

  .sophisticated-markdown a:hover {
    border-bottom-color: rgba(17, 24, 39, 0.6);
  }

  .sophisticated-markdown ul,
  .sophisticated-markdown ol {
    margin: 1.5rem 0;
    padding-left: 1.5rem;
  }

  .sophisticated-markdown li {
    margin: 0.65rem 0;
  }

  .sophisticated-markdown pre {
    background: #f8fafc;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 1.25rem;
    font-size: 0.95rem;
    line-height: 1.6;
  }

  .sophisticated-markdown code {
    background: #f3f4f6;
    border-radius: 4px;
    padding: 0.15rem 0.35rem;
  }

  .sophisticated-markdown blockquote {
    margin: 2rem 0;
    padding: 1.5rem;
    border-left: 2px solid #e5e7eb;
    background: #fafafa;
    font-style: italic;
  }

  .sophisticated-markdown table {
    width: 100%;
    border-collapse: collapse;
    margin: 2rem 0;
    font-size: 0.95rem;
  }

  .sophisticated-markdown th,
  .sophisticated-markdown td {
    border: 1px solid #e5e7eb;
    padding: 0.75rem 1rem;
    text-align: left;
  }

  .sophisticated-markdown img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 2rem auto;
  }

  .sophisticated-markdown hr {
    border: none;
    height: 1px;
    background: #e5e7eb;
    margin: 3rem 0;
  }

  @media (max-width: 720px) {
    .post-shell--excerpt:not(:first-of-type) {
      padding-top: 2rem;
    }

    .post-title {
      font-size: 2.1rem;
    }

    .post-shell--nested .post-title {
      font-size: 1.85rem;
    }

    .post-meta {
      font-size: 0.9rem;
    }
  }
</style>
