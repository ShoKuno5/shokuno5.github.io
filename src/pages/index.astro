---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import PostLayout from '../layouts/PostLayout.astro';
import MetaFeed from '../components/MetaFeed.astro';

const rawPosts = await getCollection('posts');

if (rawPosts.length === 0) {
  throw new Error('No posts found. At least one post is required for the meta feed.');
}

const normalizeTag = (value: string) => value.toLowerCase().replace(/[^a-z0-9]+/g, '-');

const sortedEntries = rawPosts
  .map((entry) => ({
    entry,
    slug: entry.slug.startsWith('en/') ? entry.slug.slice(3) : entry.slug,
  }))
  .sort((a, b) => b.entry.data.pubDate.getTime() - a.entry.data.pubDate.getTime());

const metaEntry = sortedEntries.find(({ entry }) => entry.data.pinned) ?? sortedEntries[0];
const inclusionEntries = sortedEntries.filter(({ slug }) => slug !== metaEntry.slug);

const { Content: MetaContent } = await metaEntry.entry.render();

const inclusionPosts = await Promise.all(
  inclusionEntries.map(async ({ entry, slug }) => {
    const { Content } = await entry.render();
    return {
      slug,
      data: entry.data,
      body: entry.body,
      Content,
    };
  }),
);

const tagMap = new Map<string, { label: string; count: number }>();
for (const { data } of inclusionPosts) {
  const tags = data.tags ?? [];
  for (const originalTag of tags) {
    const key = normalizeTag(originalTag);
    const record = tagMap.get(key);
    if (record) {
      record.count += 1;
    } else {
      tagMap.set(key, { label: originalTag, count: 1 });
    }
  }
}

const topTags = Array.from(tagMap.entries())
  .sort((a, b) => b[1].count - a[1].count)
  .slice(0, 8)
  .map(([key, { label, count }]) => ({ key, label, count }));
---

<Layout
  title="Sho Kuno â€” Posts"
  description="A single chronological stream of posts: research, projects, updates, and notes."
>
  <PostLayout
    title={metaEntry.entry.data.title}
    description={metaEntry.entry.data.description || metaEntry.entry.data.summary}
    date={metaEntry.entry.data.pubDate}
    modified={metaEntry.entry.data.modified}
    tags={metaEntry.entry.data.tags}
    content={metaEntry.entry.body}
    mode="homepage"
    slug={metaEntry.slug}
    showComments={false}
    variant="meta"
  >
    <MetaContent />

    <MetaFeed posts={inclusionPosts} topTags={topTags} />
  </PostLayout>
</Layout>
