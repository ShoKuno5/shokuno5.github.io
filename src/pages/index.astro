---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import PostCard from '../components/PostCard.astro';
import TimelineScript from '../components/scripts/TimelineScript.astro';
import { SITE } from '../config/site.js';
import { filterPublishedPosts } from '../utils/postVisibility';
import { buildPostCatalog } from '../utils/postCatalog';

const entries = filterPublishedPosts(await getCollection('posts'));

if (entries.length === 0) {
  throw new Error('No posts found. Add at least one post to render the homepage.');
}

const catalog = buildPostCatalog(entries);

const rendered = await Promise.all(
  catalog.map(async (post) => {
    const { Content } = await post.entry.render();
    const anchorId = `post-${post.slug.replace(/[^a-zA-Z0-9_-]+/g, '-')}`;
    return { ...post, Content, anchorId };
  })
);

const hasMathInFeed = rendered.some((post) => post.hasMath);
const hasCitationsInFeed = rendered.some((post) => post.hasCitations);
---

<Layout
  title={`${SITE.name} - Home`}
  description={SITE.tagline}
  enableMath={hasMathInFeed}
  enableCitations={hasCitationsInFeed}
>
  <header class="intro">
    <h1 class="intro-title">{SITE.name}</h1>
    {SITE.tagline && <p class="intro-lede">{SITE.tagline}</p>}
  </header>

  {rendered.length > 1 && (
    <nav class="timeline-jump" aria-label="Timeline shortcuts">
      <span class="timeline-jump__label">Jump to</span>
      <div class="timeline-jump__links">
        {rendered.map((post) => (
          <a class="timeline-jump__link" href={`#${post.anchorId}`}>
            {post.title}
          </a>
        ))}
      </div>
    </nav>
  )}

  <div id="posts" aria-label="Posts">
    <div class="post-list">
      {rendered.map(({ Content, ...post }) => (
        <PostCard
          id={post.anchorId}
          title={post.title}
          href={`/posts/${post.slug}/`}
          description={post.excerpt}
          publishedDate={post.publishedDate}
          updatedDate={post.updatedDate}
          pinned={post.pinned}
          tagLinks={post.tags.map((tag) => ({
            label: tag.label,
            href: `/tags/#tag-${tag.slug}`,
          }))}
          dataTags={post.normalizedTags}
          reveal
        >
          <Content />
        </PostCard>
      ))}
    </div>
  </div>

  <TimelineScript slot="scripts" />
</Layout>
