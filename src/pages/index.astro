---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import { SITE } from '../config/site.js';
import { normalizeTag } from '../utils/tags';

const entries = await getCollection('posts');

if (entries.length === 0) {
  throw new Error('No posts found. Add at least one post to render the homepage.');
}

const normalized = entries.map((entry) => ({
  entry,
  slug: entry.slug,
}));

const rendered = await Promise.all(
  normalized.map(async ({ entry, slug }) => {
    const { Content } = await entry.render();
    return { entry, slug, Content };
  })
);

const sorted = rendered.sort(
  (a, b) => b.entry.data.pubDate.getTime() - a.entry.data.pubDate.getTime()
);

const pinnedPosts = sorted.filter((item) => item.entry.data.pinned);
const unpinnedPosts = sorted.filter((item) => !item.entry.data.pinned);
const posts = pinnedPosts.length > 0 ? [...pinnedPosts, ...unpinnedPosts] : sorted;

const formatDate = (value: Date) =>
  value.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });

---

<Layout title={`${SITE.name} - Home`} description={SITE.tagline}>
  <header class="intro">
    <h1 class="intro-title">{SITE.name}</h1>
    {SITE.tagline && <p class="intro-lede">{SITE.tagline}</p>}
  </header>

  <div id="posts" aria-label="Posts">
    <div class="post-list">
      {posts.map(({ entry, slug, Content }) => (
        <article
          class="post-item"
          data-tags={(entry.data.tags ?? []).map(normalizeTag).join(' ')}
        >
          <div class="post-item__meta">
            {entry.data.pinned && <span class="tag-pill">Pinned</span>}
            <time datetime={entry.data.pubDate.toISOString()}>{formatDate(entry.data.pubDate)}</time>
            {(entry.data.tags ?? []).map((tag) => (
              <a class="tag-pill" href={`/tags/#tag-${normalizeTag(tag)}`}>#{tag}</a>
            ))}
          </div>
          <a class="post-item__title" href={`/posts/${slug}/`}>{entry.data.title}</a>
          {(entry.data.description || entry.data.summary) && (
            <p class="post-item__excerpt">{entry.data.description || entry.data.summary}</p>
          )}
          <div class="post-body markdown-body">
            <Content />
          </div>
        </article>
      ))}
    </div>
  </div>
</Layout>
