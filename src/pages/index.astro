---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import { SITE } from '../config/site.js';
import { normalizeTag } from '../utils/tags';
import { getPostDates } from '../utils/postDates';

const entries = await getCollection('posts');

if (entries.length === 0) {
  throw new Error('No posts found. Add at least one post to render the homepage.');
}

const normalized = entries.map((entry) => ({
  entry,
  slug: entry.slug,
}));

const rendered = await Promise.all(
  normalized.map(async ({ entry, slug }) => {
    const { Content } = await entry.render();
    const { published, updated } = getPostDates(entry);
    return { entry, slug, Content, publishedDate: published, updatedDate: updated };
  })
);

const sorted = rendered.sort(
  (a, b) => b.updatedDate.getTime() - a.updatedDate.getTime()
);

const pinnedPosts = sorted.filter((item) => item.entry.data.pinned);
const unpinnedPosts = sorted.filter((item) => !item.entry.data.pinned);
const posts = pinnedPosts.length > 0 ? [...pinnedPosts, ...unpinnedPosts] : sorted;

const formatDate = (value: Date) =>
  value.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });

---

<Layout title={`${SITE.name} - Home`} description={SITE.tagline}>
  <header class="intro">
    <h1 class="intro-title">{SITE.name}</h1>
    {SITE.tagline && <p class="intro-lede">{SITE.tagline}</p>}
  </header>

  <div id="posts" aria-label="Posts">
    <div class="post-list">
      {posts.map(({ entry, slug, Content, publishedDate, updatedDate }) => (
        <article
          class="post-item"
          data-tags={(entry.data.tags ?? []).map(normalizeTag).join(' ')}
        >
          <a class="post-item__title" href={`/posts/${slug}/`}>{entry.data.title}</a>
          <div class="post-item__meta">
            <div class="post-item__meta-row">
              {entry.data.pinned && <span class="tag-pill">Pinned</span>}
              <span class="post-item__date">
                Published{' '}
                <time datetime={publishedDate.toISOString()}>
                  {formatDate(publishedDate)}
                </time>
              </span>
              {updatedDate.getTime() !== publishedDate.getTime() && (
                <span class="post-item__date">
                  Last updated{' '}
                  <time datetime={updatedDate.toISOString()}>{formatDate(updatedDate)}</time>
                </span>
              )}
            </div>
            {(entry.data.tags ?? []).length > 0 && (
              <div class="post-item__meta-row post-item__meta-row--tags">
                {(entry.data.tags ?? []).map((tag) => (
                  <a class="tag-pill" href={`/tags/#tag-${normalizeTag(tag)}`}>#{tag}</a>
                ))}
              </div>
            )}
          </div>
          {(entry.data.description || entry.data.summary) && (
            <p class="post-item__excerpt">{entry.data.description || entry.data.summary}</p>
          )}
          <div class="post-body markdown-body">
            <Content />
          </div>
        </article>
      ))}
    </div>
  </div>
</Layout>
