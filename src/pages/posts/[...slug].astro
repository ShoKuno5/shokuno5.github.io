---
import { getCollection } from 'astro:content';
import PostLayout from '../../layouts/PostLayout.astro';
import { filterPublishedPosts } from '../../utils/postVisibility';
import { buildPostCatalog } from '../../utils/postCatalog';
import { buildCitationIndex, getCitedByPosts } from '../../utils/citationGraph';
import { getRelatedPosts } from '../../utils/relatedPosts';
import { getPostDates } from '../../utils/postDates';

type PostPageProps = {
  post: Awaited<ReturnType<typeof getCollection<'posts'>>>[number];
  difficulty: 'intro' | 'intermediate' | 'advanced' | null;
  status: 'reviewed' | 'evergreen' | 'archived' | null;
  series: { name: string; slug: string; order?: number } | null;
  relatedPosts: { slug: string; title: string; score: number; reasons: string[] }[];
  citedByPosts: { slug: string; title: string; sharedKeys: string[] }[];
};

export async function getStaticPaths() {
  const entries = filterPublishedPosts(await getCollection('posts'));
  const catalog = buildPostCatalog(entries);
  const citationIndex = buildCitationIndex(catalog);

  return catalog.map((node) => ({
    params: { slug: node.slug },
    props: {
      post: node.entry,
      difficulty: node.difficulty,
      status: node.status,
      series: node.series,
      relatedPosts: getRelatedPosts(node, catalog),
      citedByPosts: getCitedByPosts(node.slug, catalog, citationIndex).map((item) => ({
        slug: item.slug,
        title: item.title,
        sharedKeys: item.sharedKeys,
      })),
    } as PostPageProps,
  }));
}

const {
  post,
  difficulty,
  status,
  series,
  relatedPosts,
  citedByPosts,
} = Astro.props as PostPageProps;

const { Content } = await post.render();
const { published, updated } = getPostDates(post);
---

<PostLayout
  title={post.data.title}
  date={published}
  modified={updated}
  tags={post.data.tags}
  difficulty={difficulty}
  status={status}
  series={series}
  relatedPosts={relatedPosts}
  citedByPosts={citedByPosts}
  description={post.data.description || post.data.summary}
  content={post.body}
>
  <Content />
</PostLayout>
