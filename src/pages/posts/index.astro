---
import Layout from '../../layouts/Layout.astro';
import PostLayout from '../../layouts/PostLayout.astro';
import PostLayoutWithCitations from '../../layouts/PostLayoutWithCitations.astro';
import { getCollection } from 'astro:content';
import { getGitDatesForContentSync } from '../../utils/gitDatesOptimized';
import { extractDateFromFilename } from '../../utils/extractDateFromFilename';

const posts = await getCollection('posts', ({ id }) => id.startsWith('en/') || !id.includes('/'));
const visiblePosts = posts.filter((p) => !p.data.hidden);

const sorted = visiblePosts
  .map((post) => {
    const git = getGitDatesForContentSync('posts', post.slug);
    const fileDate = extractDateFromFilename(post.slug);
    const published = post.data.pubDate || post.data.date || fileDate || git?.created || new Date(0);
    const modified = git?.modified && git.modified.getTime() !== published.getTime() ? git.modified : post.data.modified;
    return { post, published, modified };
  })
  .sort((a, b) => b.published.getTime() - a.published.getTime());
---

<Layout title="Posts - Sho Kuno" description="Latest posts in reverse chronological order">
  <section class="page-width">
    <div class="posts-heading">
      <h1>Posts</h1>
      <nav>
        <a href="/posts/all/">All posts</a>
        <a href="/posts/tags/">Tags</a>
      </nav>
    </div>

    <div class="posts-stack">
      {sorted.map(async ({ post, published, modified }) => {
        const { Content } = await post.render();
        const contentHasCitations = post.body.includes('cite{') || post.body.includes('\\cite{');
        const UseLayout = contentHasCitations ? PostLayoutWithCitations : PostLayout;
        const slug = post.slug.startsWith('en/') ? post.slug.slice(3) : post.slug;
        return (
          <UseLayout
            title={post.data.title}
            date={published}
            modified={modified}
            tags={post.data.tags}
            description={post.data.description || post.data.summary}
            content={post.body}
            mode="homepage"
            slug={slug}
            showMeta={true}
            showComments={false}
          >
            <Content />
          </UseLayout>
        );
      })}
    </div>
  </section>
</Layout>
