---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { getGitDatesForContent } from '../../utils/gitDatesOptimized';
import { extractDateFromFilename } from '../../utils/extractDateFromFilename';

// Fetch and process all posts at build time
const posts = await getCollection('posts', ({ id }) => id.startsWith('en/') || !id.includes('/'));
const visiblePosts = posts.filter(post => !post.data.hidden);

// Pre-calculate everything at build time with minimal function calls
const postsWithOptimizedData = await Promise.all(
  visiblePosts.map(async (post) => {
    // Single async call per post for git dates
    const gitDates = await getGitDatesForContent('posts', post.slug);
    const filenameDate = extractDateFromFilename(post.slug);
    const publishDate = post.data.date || filenameDate || gitDates?.created || new Date(0);
    
    let modifiedDate = post.data.modified;
    if (!modifiedDate && gitDates?.modified) {
      if (gitDates.modified.getTime() !== publishDate.getTime()) {
        modifiedDate = gitDates.modified;
      }
    }
    
    return {
      slug: post.slug,
      title: post.data.title,
      summary: post.data.summary,
      tags: post.data.tags || [],
      dates: {
        publish: publishDate,
        modified: modifiedDate
      }
    };
  })
);

// Ultra-fast tag processing with optimized data structures
const tagMap = new Map<string, typeof postsWithOptimizedData>();

postsWithOptimizedData.forEach(post => {
  post.tags.forEach(tag => {
    const normalizedTag = tag.toLowerCase();
    if (!tagMap.has(normalizedTag)) {
      tagMap.set(normalizedTag, []);
    }
    tagMap.get(normalizedTag)!.push(post);
  });
});

// Pre-sort everything at build time
const sortedTags = Array.from(tagMap.entries())
  .sort((a, b) => a[0].localeCompare(b[0]))
  .map(([tag, tagPosts]) => [
    tag,
    tagPosts.sort((a, b) => b.dates.publish.getTime() - a.dates.publish.getTime())
  ] as const);
---

<Layout title="All Tags" description="Browse posts by tags">
  <section class="page-width" id="top">
    <div class="markdown-body page-intro">
      <h1>All Tags</h1>
    </div>
    
    <nav class="tag-cloud">
      <h2>Jump to tag</h2>
      <div class="tag-cloud-list">
        {sortedTags.map(([tag, tagPosts]) => (
          <a 
            href={`#tag-${tag.replace(/\s+/g, '-')}`}
            class="tag-chip"
          >
            {tag}
            <span>{tagPosts.length}</span>
          </a>
        ))}
      </div>
    </nav>
    
    <div>
      {sortedTags.map(([tag, tagPosts]) => (
        <section id={`tag-${tag.replace(/\s+/g, '-')}`} class="tag-section">
          <h2>
            {tag}
            <span>({tagPosts.length} posts)</span>
          </h2>
          <ul class="archive-list">
            {tagPosts.map((post) => (
              <li>
                <a 
                  href={`/posts/${post.slug.startsWith('en/') ? post.slug.slice(3) : post.slug}/`}
                  class="archive-link"
                >
                  <div class="archive-content">
                    <h3>{post.title}</h3>
                    {post.summary && (
                      <p>{post.summary}</p>
                    )}
                  </div>
                  <div class="archive-meta">
                    <time>
                      {post.dates.publish.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
                    </time>
                    {post.dates.modified && (
                      <time>
                        upd: {post.dates.modified.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
                      </time>
                    )}
                  </div>
                </a>
              </li>
            ))}
          </ul>
          <div class="tag-back">
            <a href="#top">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
              </svg>
              Back to top
            </a>
          </div>
        </section>
      ))}
    </div>
  </section>
</Layout>
