---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

const entries = await getCollection('posts');

const tagsMap = new Map<string, { label: string; posts: {
  slug: string;
  title: string;
  description?: string;
  pubDate: Date;
}[] }>();

for (const entry of entries) {
  const tags = entry.data.tags ?? [];
  for (const rawTag of tags) {
    const normalized = rawTag.toLowerCase();
    const slug = entry.slug.startsWith('en/') ? entry.slug.slice(3) : entry.slug;
    if (!tagsMap.has(normalized)) {
      tagsMap.set(normalized, { label: rawTag, posts: [] });
    }
    tagsMap.get(normalized)!.posts.push({
      slug,
      title: entry.data.title,
      description: entry.data.description || entry.data.summary,
      pubDate: entry.data.pubDate,
    });
  }
}

const tags = Array.from(tagsMap.values())
  .map((tag) => ({
    ...tag,
    posts: tag.posts.sort((a, b) => b.pubDate.getTime() - a.pubDate.getTime()),
  }))
  .sort((a, b) => a.label.localeCompare(b.label));
---

<Layout title="Tags â€” Sho Kuno" description="Browse the post network by tag and discover related threads.">
  <section class="page-width tags" id="top">
    <header class="tags__intro">
      <h1>Tag graph</h1>
      <p>Each tag is a thread through the post web. Jump to a tag to see everything connected to it.</p>
      {tags.length > 0 && (
        <div class="tags__cloud">
          {tags.map((tag) => (
            <a class="tags__chip" href={`#tag-${tag.label.toLowerCase().replace(/[^a-z0-9]+/g, '-')}`}>
              #{tag.label}
              <span>{tag.posts.length}</span>
            </a>
          ))}
        </div>
      )}
    </header>

    <div class="tags__sections">
      {tags.map((tag) => (
        <section class="tags__section" id={`tag-${tag.label.toLowerCase().replace(/[^a-z0-9]+/g, '-')}`}>
          <header>
            <h2>#{tag.label}</h2>
            <span>{tag.posts.length} post{tag.posts.length === 1 ? '' : 's'}</span>
          </header>
          <ul>
            {tag.posts.map((post) => (
              <li>
                <a href={`/posts/${post.slug}/`}>
                  <div>
                    <h3>{post.title}</h3>
                    {post.description && <p>{post.description}</p>}
                  </div>
                  <time datetime={post.pubDate.toISOString()}>
                    {post.pubDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
                  </time>
                </a>
              </li>
            ))}
          </ul>
          <div class="tags__back">
            <a href="#top">Back to top</a>
          </div>
        </section>
      ))}
    </div>
  </section>
</Layout>

<style>
  .tags {
    display: flex;
    flex-direction: column;
    gap: 3rem;
  }

  .tags__intro {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .tags__intro h1 {
    margin: 0;
    font-size: clamp(2rem, 5vw, 2.6rem);
    font-weight: 800;
    letter-spacing: -0.02em;
  }

  .tags__intro p {
    margin: 0;
    color: #475569;
    max-width: 36rem;
    line-height: 1.7;
  }

  .tags__cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-top: 0.5rem;
  }

  .tags__chip {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 1rem;
    border-radius: 999px;
    border: 1px solid rgba(30, 64, 175, 0.25);
    background: rgba(59, 130, 246, 0.12);
    color: #1d4ed8;
    font-weight: 600;
    font-size: 0.85rem;
    text-decoration: none;
    transition: background 0.2s ease, transform 0.2s ease;
  }

  .tags__chip span {
    font-size: 0.75rem;
    opacity: 0.8;
  }

  .tags__chip:hover,
  .tags__chip:focus-visible {
    background: rgba(59, 130, 246, 0.22);
    transform: translateY(-1px);
    outline: none;
  }

  .tags__sections {
    display: flex;
    flex-direction: column;
    gap: 2.5rem;
  }

  .tags__section {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .tags__section > header {
    display: flex;
    align-items: baseline;
    gap: 0.75rem;
  }

  .tags__section > header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
  }

  .tags__section > header span {
    font-size: 0.9rem;
    color: #64748b;
  }

  .tags__section ul {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0.85rem;
  }

  .tags__section li a {
    display: flex;
    justify-content: space-between;
    gap: 1.5rem;
    padding: 1.5rem;
    border-radius: 1.25rem;
    border: 1px solid rgba(226, 232, 240, 0.9);
    background: rgba(255, 255, 255, 0.85);
    text-decoration: none;
    color: inherit;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .tags__section li a:hover,
  .tags__section li a:focus-visible {
    transform: translateY(-3px);
    box-shadow: 0 16px 34px -26px rgba(15, 23, 42, 0.3);
    outline: none;
  }

  .tags__section h3 {
    margin: 0;
    font-size: 1.05rem;
    font-weight: 600;
  }

  .tags__section p {
    margin: 0.3rem 0 0;
    color: #475569;
    font-size: 0.95rem;
    line-height: 1.6;
  }

  .tags__section time {
    font-size: 0.85rem;
    color: #64748b;
    white-space: nowrap;
  }

  .tags__back {
    font-size: 0.85rem;
  }

  .tags__back a {
    color: #1d4ed8;
    text-decoration: none;
  }

  .tags__back a:hover,
  .tags__back a:focus-visible {
    text-decoration: underline;
    outline: none;
  }

  @media (max-width: 720px) {
    .tags__section li a {
      flex-direction: column;
      align-items: flex-start;
    }

    .tags__section time {
      margin-top: 0.5rem;
    }
  }
</style>
