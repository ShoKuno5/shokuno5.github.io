---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import { SITE } from '../config/site.js';
import { filterPublishedPosts } from '../utils/postVisibility';
import { buildPostCatalog, type PostCatalogItem } from '../utils/postCatalog';

type TopicHub = {
  label: string;
  slug: string;
  posts: PostCatalogItem[];
};

const entries = filterPublishedPosts(await getCollection('posts'));
const catalog = buildPostCatalog(entries);

const topicsMap = new Map<string, TopicHub>();

catalog.forEach((post) => {
  post.topics.forEach((topic) => {
    if (!topicsMap.has(topic.slug)) {
      topicsMap.set(topic.slug, {
        ...topic,
        posts: [],
      });
    }
    topicsMap.get(topic.slug)?.posts.push(post);
  });
});

const topics = Array.from(topicsMap.values()).sort((a, b) => {
  if (b.posts.length !== a.posts.length) {
    return b.posts.length - a.posts.length;
  }
  return a.label.localeCompare(b.label);
});

const formatDate = (value: Date) =>
  value.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
---

<Layout title={`${SITE.name} - Topics`} description="Topic hubs across research notes and essays.">
  <header class="intro">
    <h1 class="intro-title">Topics</h1>
    <p class="intro-lede">Structured hubs that connect posts with shared concepts.</p>
  </header>

  {topics.length === 0 ? (
    <p class="topic-empty">No topic metadata yet. Add a <code>topics</code> array to post frontmatter.</p>
  ) : (
    <section class="topic-hubs">
      {topics.map((topic) => (
        <article class="topic-hub" id={`topic-${topic.slug}`}>
          <header class="topic-hub__header">
            <h2 class="topic-hub__title">{topic.label}</h2>
            <span class="topic-hub__count">
              {topic.posts.length} post{topic.posts.length === 1 ? '' : 's'}
            </span>
          </header>

          <ul class="topic-hub__list">
            {topic.posts.map((post) => (
              <li>
                <a href={`/posts/${post.slug}/`}>{post.title}</a>
                <span>
                  {' '}
                  Updated <time datetime={post.updatedDate.toISOString()}>{formatDate(post.updatedDate)}</time>
                </span>
                {post.series && (
                  <span>
                    {' '}
                    | Series: <a href={`/series/#series-${post.series.slug}`}>{post.series.name}</a>
                  </span>
                )}
              </li>
            ))}
          </ul>
        </article>
      ))}
    </section>
  )}
</Layout>
